let gql,AuthenticationError,GraphQLUpload,Storage,join,Post,config,pubsub;_fb8‍.x([["typeDefs",()=>typeDefs],["resolvers",()=>resolvers],["default",()=>_fb8‍.o]]);_fb8‍.w("apollo-server-express",[["gql",["gql"],function(v){gql=v}],["AuthenticationError",["AuthenticationError"],function(v){AuthenticationError=v}]]);_fb8‍.w("graphql-upload",[["GraphQLUpload",["GraphQLUpload"],function(v){GraphQLUpload=v}]]);_fb8‍.w("@google-cloud/storage",[["Storage",["Storage"],function(v){Storage=v}]]);_fb8‍.w("path",[["join",["join"],function(v){join=v}]]);_fb8‍.w("../../models/post",[["default",["Post"],function(v){Post=v}]]);_fb8‍.w("../../utils/config",[["default",["config"],function(v){config=v}]]);_fb8‍.w("../../utils/pubsub",[["default",["pubsub"],function(v){pubsub=v}]]);







       const typeDefs = gql`
  scalar Upload

  type File {
    filename: String!
    mimetype: String!
    encoding: String!
    url: String!
  }

  type Mutation {
    createPost(
      title: String!,
      description: String,
      tags: [String!]!
      files: [Upload!]!
    ): Post
  }

  type Subscription {
    postAdded: Post!
  }
`

const gc = new Storage({
  keyFilename: join(__dirname, '../../../fleet-petal-329519-cb1e7f8f25e8.json'),
  projectId: 'fleet-petal-329519'
});

const audioBucket = gc.bucket('masterclass_audio_assets');

       const resolvers = {
  Upload: GraphQLUpload,

  Mutation: {
    createPost: async (_root, { title, description, tags, files }, { currentUser }) => {
      if (!currentUser) throw new AuthenticationError('not authenticated');
      
      const uploadedFileUrls = await Promise.all(files.map(async (file) => {
        const { createReadStream, filename } = await file;
        const cloudFile = audioBucket.file(filename);

        await new Promise(resolve => 
          createReadStream()
            .pipe(
              cloudFile.createWriteStream({
                gzip: false
              })
            )
            .on('finish', resolve)
        );

        const url = `http://${config.GCLOUD_LB_IP}/${filename}`;
        return url;
      }));

      const newPost = new Post({
        title,
        description,
        tags,
        audioFileUris: uploadedFileUrls,
        dateCreatedAt: new Date(),
        user: currentUser._id
      });
      const { _id: id } = await newPost.save();

      currentUser.posts = [...currentUser.posts, id];
      await currentUser.save();

      await newPost
        .populate([{ path: 'user', select: 'id username'}, { path: 'tags' }]);

      pubsub.publish('POST_ADDED', { postAdded: newPost });

      return newPost;
    }
  },
  Subscription: {
    postAdded: {
      subscribe: () => pubsub.asyncIterator(['POST_ADDED'])
    }
  }
}

_fb8‍.d({ typeDefs, resolvers });